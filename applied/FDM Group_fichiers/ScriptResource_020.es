window.FuManchu=function(){"use strict";function t(t){this.source=t.toString(),this.tokens=this._lexer(this.source)}function e(t){this.source=t,this.type=this._getType(this.source),"data"!==this.type&&"block-start"!==this.type&&"template"!==this.type&&"template-object"!==this.type&&"render-object"!==this.type&&"resource"!==this.type||(this.data=this._getDataReference(this.source))}t.prototype.templates={},t.prototype.registerTemplate=function(e,r){var n=t(r);t.prototype.templates[e]=n.Process.bind(n)},t.prototype.Process=function(t){try{return this._parser(this._clone(t))}catch(t){console.error("Failed to process FuManchu template: ",t.message)}},t.prototype._clone=function(t){return t?Object.assign(Object.create(Object.getPrototypeOf(t)),t):null},t.prototype._fuManchuTokens={all:/{{(?:\s|\S)*?}}/g,resource:/{{res\s+(\w|\s)+\s*}}/g,data:/{{[^\/#@!>]\s*\S{0,}\s*}}/g,comment:/{{!(?:\s|\S)*?}}/g,template:/{{>\s+.*?}}/g,templateObject:/{{>>\s+.*?}}/g,renderObject:/{{>render\s+.*?}}/g,action:/{{@\w+\s+(?:(?:[^}]\S)+\s*)+}}/g,block:{start:/{{#\w+\s+\S+(?:\s*\S+\s*)*?}}/g,else:/{{\s*else\s*}}/g,end:/{{\/\w+\s*}}/g,type:/[#\/]\w*\b/g}},t.prototype._lexer=function(t){for(var r=new Array,n=t.match(this._fuManchuTokens.all),o=0,s=0;s!==t.length;){var a=t.length;n&&o<n.length&&(a=t.indexOf(n[o],s));var c=t.substring(s,a);r.push(new e(c)),n&&o<n.length&&(a=(s=a)+n[o].length,c=t.substring(s,a),r.push(new e(c)),o++),s=a}return r},t.prototype._parser=function(t){var e="",r={prev:null,current:null,next:null,blocks:[],index:0};for(r.index=0;r.index<this.tokens.length;r.index++){if(r.current&&(r.prev=r.current),r.current=this.tokens[r.index],r.index<this.tokens.length-1?r.next=this.tokens[r.index+1]:r.next=null,r.currentBlock=r.blocks[r.blocks.length-1],!r.next&&r.currentBlock&&"block-end"!==r.current.type){console.error("Error: Unexpected end of template; missing {/"+r.currentBlock.type+"}?");break}if("block-start"===r.current.type){var n={type:r.current.blockType,skip:!1};if(r.currentBlock&&r.currentBlock.skip?(n.skip=!0,n.skipNest=!0):n.skip=!r.current.value(t),"each"===r.current.blockType)if(n.skip)n.iterate=function(){return!1};else{n.loopFromIndex=r.index,n.iterationIndex=0;var o=r.current.value(t);if(o&&!Array.isArray(o)){var s=new Array;Object.keys(o).forEach((function(t){s.push(o[t])})),o=s}n.data=o,n.skip=!(n.data.length>0),n.originalContext=t;var a=this;n.setLoopContext=function(){(t=a._clone(this.data[this.iterationIndex]||{}))["@first"]=0===this.iterationIndex,t["@last"]=this.iterationIndex===(0===this.data.length?this.data.length:this.data.length-1),t["@index"]=this.iterationIndex,t["@even"]=this.iterationIndex%2==0,t["@context"]=t,t["@originalContext"]=this.originalContext}.bind(n),n.setLoopContext(),n.iterate=function(){if(!this.else){if(!this.skip&&!t["@last"])return r.index=this.loopFromIndex,++this.iterationIndex,this.setLoopContext(),!0;t["@originalContext"]&&(t=t["@originalContext"])}return!1}.bind(n)}r.blocks.push(n)}else if("block-end"===r.current.type){if(!r.currentBlock){console.error("Error: Unexpected end of block; missing start of {/"+r.current.blockType+"} block?");break}if(r.current.blockType!==r.currentBlock.type){console.error("Error: Unexpected end of block; attempting to close outer {#"+this.current.blockType+"} block before inner {#"+r.currentBlock.type+"} block?");break}if("each"===r.current.blockType&&r.currentBlock.iterate())continue;r.blocks.pop()}else if("block-else"===r.current.type){if(!r.currentBlock){console.error("Error: Unexpected else block");break}if(!r.currentBlock.skipNest){if("each"===r.currentBlock.type){if(r.currentBlock.iterate())continue;r.currentBlock.else=!0}r.currentBlock.skip=!r.currentBlock.skip}}else{if(r.currentBlock&&r.currentBlock.skip)continue;e+=r.current.value(t)}}return e},e.prototype._getType=function(e){return e.match(t.prototype._fuManchuTokens.resource)?"resource":e.match(t.prototype._fuManchuTokens.comment)?"comment":e.match(t.prototype._fuManchuTokens.block.else)?"block-else":e.match(t.prototype._fuManchuTokens.data)?"data":e.match(t.prototype._fuManchuTokens.block.start)?(this.blockType=e.match(t.prototype._fuManchuTokens.block.type)[0].substring(1,e.length-1),"block-start"):e.match(t.prototype._fuManchuTokens.block.end)?(this.blockType=e.match(t.prototype._fuManchuTokens.block.type)[0].substring(1,e.length-1),"block-end"):e.match(t.prototype._fuManchuTokens.templateObject)?"template-object":e.match(t.prototype._fuManchuTokens.template)?"template":e.match(t.prototype._fuManchuTokens.renderObject)?"render-object":e.match(t.prototype._fuManchuTokens.action)?"action":"content"},e.prototype._getDataReference=function(t){var e=t.substring(2,t.length-2);if(e=e.trim().split(" "),"data"===this.type)return{ref:e[0],path:e[0].split(".")};if("resource"===this.type)return{moduleID:e[1],key:e[2]};var r={ref:e[1],path:e[1].split(".")};return e.length>2&&(e=e.splice(2),r.params=new Array,e.forEach((function(t){""!=(t=t.trim())&&r.params.push({ref:"null"===t?null:t,path:t.split(".")})}))),r},e.prototype.value=function(e){switch(this.type){case"content":return this.source;case"resource":if(this.data&&this.data.moduleID&&this.data.key)return window.ResourceStore.get(this.data.moduleID,this.data.key);throw new Error("Required values not passed to FuManchu resource template",this);case"data":return null==(r=this._contextValue(e))&&(r=""),r;case"block-start":var r=this._contextValue(e);if("if"===this.blockType||"unless"===this.blockType||"any"===this.blockType||"unlessany"===this.blockType){var n=!1;if(this.data.params&&this.data.params.length>0)if(this.blockType.indexOf("any")>-1)for(var o=0;o<this.data.params.length;o++){if(r==(this._contextValue(e,0,this.data.params[o])||this.data.params[o].ref)){n=!0;break}}else n=r==(this._contextValue(e,0,this.data.params[0])||this.data.params[0].ref);else n=!!r;return this.blockType.indexOf("unless")>-1&&(n=!n),n}return r;case"template-object":return this._contextValue(e,0)(a=this.data.params&&this.data.params.length>1?this._contextValue(e,0,this.data.params[0]):e);case"template":var s=this.data.ref;if(t.prototype.templates[s]){var a=this.data.params&&this.data.params.length>0?this._contextValue(e,0,this.data.params[0]):e;return t.prototype.templates[s](a)}return"";case"render-object":var c=this._contextValue(e,0);return c&&"function"==typeof c._Render?c._Render():"";default:return""}},e.prototype._contextValue=function(t,e,r){e=e||0,r=r||this.data;var n=t[r.path[e]],o=function(n){if(void 0===n){var o=r.path[e];"true"===o?n=!0:"false"===o||(n="")}return"function"==typeof n&&(n=n.call(t)),"string"==typeof n&&(n=n.trim()),n};return e===r.path.length-1?o(n):void 0!==n?o(this._contextValue(n,e+1,r)):void 0};var r=function(e){return new t(e)};return r.registerTemplate=function(e,r){var n=new t(r);return t.prototype.templates[e]=n.Process.bind(n),t.prototype.templates[e]},r}();